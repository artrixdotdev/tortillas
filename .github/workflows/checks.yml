name: âœ… Checks
on:
   # No long run pushes on main since it will be called by the release workflow
   # push:
   #   branches: [ "main" ]
   pull_request:
      branches: ["main"]
   workflow_call:

env:
   CARGO_TERM_COLOR: always
   RUSTFLAGS: "-C target-cpu=native"
   CARGO_INCREMENTAL: 0
   RUST_BACKTRACE: 1

jobs:
   build_and_test:
      runs-on: ubuntu-latest
      steps:
         - name: ğŸ“¥ Checkout code
           uses: actions/checkout@v4

         - name: ğŸ¦€ Install Rust toolchain
           uses: dtolnay/rust-toolchain@nightly
           with:
              components: clippy, rustfmt

         - name: ğŸ’¾ Rust Cache
           uses: Swatinem/rust-cache@v2
           with:
              shared-key: "build-cache"

         - name: ğŸ”¨ Build
           run: cargo build --verbose

         - name: Install latest nextest release
           uses: taiki-e/install-action@nextest

         - name: ğŸ§ª Run tests
           uses: actions-rs/cargo@v1
           with:
              command: nextest
              args: run --nocapture --no-fail-fast

   lint:
      runs-on: ubuntu-latest
      steps:
         - name: ğŸ“¥ Checkout code
           uses: actions/checkout@v4

         - name: ğŸ¦€ Install Rust toolchain
           uses: dtolnay/rust-toolchain@nightly
           with:
              components: clippy, rustfmt

         - name: ğŸ’¾ Rust Cache
           uses: Swatinem/rust-cache@v2
           with:
              shared-key: "lint-cache"

         - name: ğŸ” Run linter
           run: cargo clippy --all-targets --all-features -- -D warnings

         - name: ğŸ’… Run format checker
           run: cargo fmt --check

         - name: ğŸ“– Run doc linter
           run: cargo doc --no-deps --document-private-items
